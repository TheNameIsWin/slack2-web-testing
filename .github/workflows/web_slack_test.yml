name: "Slack Deployment Test"
run-name: "Slack Test - [${{ github.ref_name }}]"

on:
  push:
    branches:
      - main
      - develop
      - staging
  workflow_dispatch:

jobs:
  slack-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ⭐ EXTRACT ONLY THE LATEST COMMIT MESSAGE
      - name: Extract Latest Commit
        id: deployment-info
        run: |
          LATEST=$(git log -1 --pretty=format:"%s")
          echo "info<<EOF" >> $GITHUB_OUTPUT
          echo "$LATEST" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # ⭐ SEND TO SLACK
      - name: Notify Slack
        env:
          SLACK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          INFO="${{ steps.deployment-info.outputs.info }}"
          DATE=$(date '+%d-%b-%Y %H:%M:%S')
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          PAYLOAD=$(jq -n \
            --arg branch "${{ github.ref_name }}" \
            --arg info "$INFO" \
            --arg date "$DATE" \
            --arg run_url "$RUN_URL" \
            '{
              text: "*Test Deployment Notification*\n*Branch:* \($branch)\n\n*Latest Commit:*\n```\n\($info)\n```\nTriggered at: \($date)\nGitHub Actions: <\($run_url)|View Run>"
            }')

          curl -X POST -H "Content-type: application/json" \
            --data "$PAYLOAD" \
            "$SLACK_URL"
