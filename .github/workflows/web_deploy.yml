name: 'Slack Notifications'
on:
  pull_request:
    types: [opened, synchronize, closed]
    branches: [dev]
  push:
    branches: [stage, prod]
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Extract PR info
      - name: Extract PR Info
        if: github.event_name == 'pull_request'
        id: pr-info
        run: |
          echo "title<<EOF" >> $GITHUB_OUTPUT
          echo "${{ github.event.pull_request.title }}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "desc<<EOF" >> $GITHUB_OUTPUT
          echo "${{ github.event.pull_request.body || 'No description provided.' }}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "state=${{ github.event.pull_request.state }}" >> $GITHUB_OUTPUT
          echo "merged=${{ github.event.pull_request.merged }}" >> $GITHUB_OUTPUT
          echo "run_url=${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_OUTPUT

      # Extract Changelog
      - name: Extract Changelog
        if: github.event_name != 'pull_request'
        id: changelog
        run: |
          if [ ! -f CHANGELOG.md ]; then
            echo "changelog<<EOF" >> $GITHUB_OUTPUT
            echo "* No CHANGELOG.md found. Add one for deployment details!" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            # Parse latest unreleased section (improved awk for bullets)
            LATEST=$(awk '
              /^## \[[Uu]nreleased[^]]*\] - / { in_section=1; next }
              in_section && /^### / { gsub(/^### /, "• "); print; next }
              in_section && /^## / { in_section=0 }
              in_section { print "• " $0 }
            ' CHANGELOG.md | head -20)
            if [ -z "$LATEST" ]; then LATEST="* No recent changes listed."; fi
            echo "changelog<<EOF" >> $GITHUB_OUTPUT
            echo "$LATEST" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi
          echo "branch=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          echo "run_url=${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_OUTPUT

      # Send to Slack (fixed script)
      - name: Send to Slack
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
          DATE: $(date '+%d-%b-%Y %H:%M:%S')
          EVENT_NAME: ${{ github.event_name }}
          PR_TITLE: ${{ steps.pr-info.outputs.title || '' }}
          PR_DESC: ${{ steps.pr-info.outputs.desc || '' }}
          PR_STATE: ${{ steps.pr-info.outputs.state || '' }}
          PR_MERGED: ${{ steps.pr-info.outputs.merged || 'false' }}
          BRANCH: ${{ steps.changelog.outputs.branch || github.ref_name }}
          RUN_URL: ${{ steps.pr-info.outputs.run_url || steps.changelog.outputs.run_url }}
          CHANGELOG: ${{ steps.changelog.outputs.changelog || '' }}
        run: |
          if [ "$EVENT_NAME" = "pull_request" ]; then
            STATE="New PR"
            if [ "$PR_STATE" = "closed" ] && [ "$PR_MERGED" = "true" ]; then
              STATE="Merged PR"
            fi
            TEXT="*${STATE} on Dev!*\n\n*Title:* $PR_TITLE\n*Description:* $PR_DESC\n\n*Branch:* dev\n*Triggered at:* $DATE\n<$RUN_URL|GitHub Actions: View Run>"
            curl -X POST -H 'Content-type: application/json' \
              --data "{\"text\": \"$TEXT\"}" \
              "$SLACK_WEBHOOK"
          else
            ENV=$(echo "$BRANCH" | tr '[:lower:]' '[:upper:]')
            TEXT="*Test Deployment Notification*\n\n*Branch:* $BRANCH\n*Changes:*\n$CHANGELOG\n\n*Environment:* $ENV\n*Triggered at:* $DATE\n<$RUN_URL|GitHub Actions: View Run>"
            curl -X POST -H 'Content-type: application/json' \
              --data "{\"text\": \"$TEXT\"}" \
              "$SLACK_WEBHOOK"
          fi