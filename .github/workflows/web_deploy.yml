name: '[Ondemand] Test Web Slack Notification'
run-name: '[${{ inputs.environment }}] Web Slack Test'

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment'
        required: true
        default: 'dev.zentium.ai'

jobs:
  build:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/web

    steps:
      - uses: actions/checkout@main

      # ðŸ”¥ Step 1: Extract last 5 commit messages
      - name: Get Deployment Info
        id: info
        run: |
          COMMITS=$(git log -5 --pretty=format:"â€¢ %s")
          echo "COMMITS<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # ðŸ”¥ Step 2: Send Slack Notification (Success)
      - name: Notify Slack - Success
        if: success()
        env:
          TARGET_ENVIRONMENT: ${{ inputs.environment }}
        run: |
          DATE=$(date '+%d-%b-%Y %H:%M:%S')
          curl -X POST -H 'Content-type: application/json' \
          --data "{
            \"text\": \"*Web App Deployment Successful!*\n\n*Environment:* ${TARGET_ENVIRONMENT}\n\n*Changes:*\n${{ steps.info.outputs.COMMITS }}\n\nDeployed at: ${DATE}\"
          }" \
          ${{ secrets.SLACK_WEBHOOK_URL }}

      # ðŸ”¥ Step 3: Slack Notification (Failure)
      - name: Notify Slack - Failure
        if: failure()
        env:
          TARGET_ENVIRONMENT: ${{ inputs.environment }}
        run: |
          DATE=$(date '+%d-%b-%Y %H:%M:%S')
          curl -X POST -H 'Content-type: application/json' \
          --data "{
            \"text\": \"*Web App Deployment Failed!*\n\n*Environment:* ${TARGET_ENVIRONMENT}\n\n*Check Logs in GitHub Actions.*\nFailed at: ${DATE}\"
          }" \
          ${{ secrets.SLACK_WEBHOOK_URL }}
