name: 'Combined Slack Notification'
run-name: '[${{ inputs.environment }}] Test Deployment Notification'

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'The environment to deploy to'
        required: true
        type: choice
        options:
          - dev.zentium.ai
          - staging.zentium.ai
          - app.zentium.ai
        default: 'dev.zentium.ai'

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # For git log/API/changelog

      # Extract Info (PR for dev, Changelog for stage/prod)
      - name: Extract Deployment Info
        id: info
        run: |
          TARGET_ENV="${{ inputs.environment == 'app.zentium.ai' && 'prod' || inputs.environment == 'staging.zentium.ai' && 'stage' || 'dev' }}"
          CURRENT_BRANCH="${{ github.ref_name }}"
          COMMIT_INFO=""

          if [ "$TARGET_ENV" = "dev" ]; then
            echo "Extracting PR for dev"
            if [ "$CURRENT_BRANCH" = "develop" ]; then
              # Real PR from merge commit
              MERGE_COMMIT=$(git log -1 --pretty=%B 2>/dev/null || echo "")
              if echo "$MERGE_COMMIT" | grep -q "Merge pull request"; then
                PR_NUM=$(echo "$MERGE_COMMIT" | grep -o "Merge pull request #[0-9]*" | grep -o "[0-9]*" | head -1)
                if [ -n "$PR_NUM" ]; then
                  PR_DATA=$(curl -s -H "Authorization: token $GH_TOKEN" \
                    "https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUM")
                  PR_TITLE=$(echo "$PR_DATA" | grep -o '"title":"[^"]*"' | head -1 | cut -d'"' -f4 || echo "Untitled PR")
                  PR_BODY=$(python3 -c "import json, sys; data = json.load(sys.stdin); body = data.get('body', '') or ''; body = body.replace('\n', ' ').replace('\r', '')[:200] + ('...' if len(body) > 200 else '') if body and body != 'null' else ''; print(body)" <<< "$PR_DATA" 2>/dev/null || echo "No description.")
                  COMMIT_INFO="• *PR #${PR_NUM}:* ${PR_TITLE}\n• *Description:* ${PR_BODY}"
                fi
              fi
            else
              # Fake for test
              COMMIT_INFO="• *PR #123:* Fix the PR relevant issues\n• *Description:* Updated recent data to my file for testing."
            fi
          else
            # Changelog for stage/prod
            echo "Extracting changelog for $TARGET_ENV"
            if [ -f CHANGELOG.md ]; then
              LATEST=$(awk '/^## \[[Uu]nreleased/ {flag=1; next} flag && /^### / {gsub(/^### /, "• "); print; next} flag && /^[ \t]*[-*]/ {gsub(/^[ \t]*[-*] /, "• "); print} flag && /^## / {flag=0}' CHANGELOG.md | head -15)
              if [ -n "$LATEST" ]; then
                COMMIT_INFO="$LATEST"
              else
                COMMIT_INFO="• No unreleased changes."
              fi
            else
              COMMIT_INFO="• *No CHANGELOG.md* - Add one for details.\n• Test entry: Added notification logic."
            fi
          fi

          if [ -z "$COMMIT_INFO" ]; then
            COMMIT_INFO="• No changes extracted."
          fi

          echo "commits<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMIT_INFO" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "branch=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          echo "run_url=${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}

      # Send Slack Notification
      - name: Notify Slack
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
          COMMITS: ${{ steps.info.outputs.commits }}
          BRANCH: ${{ steps.info.outputs.branch }}
          RUN_URL: ${{ steps.info.outputs.run_url }}
        run: |
          DATE=$(date '+%d-%b-%Y %H:%M:%S')
          TEXT="*Test Deployment Notification*\n\n*Branch:* ${BRANCH}\n*Commit Info:*\n\n${COMMITS}\n\nTriggered at: ${DATE}\nGitHub Actions: <${RUN_URL}|View Run>"
          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\": \"$TEXT\"}" \
            "$SLACK_WEBHOOK"